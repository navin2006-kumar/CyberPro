FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install base utilities and dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    nano \
    net-tools \
    iputils-ping \
    dnsutils \
    netcat \
    telnet \
    traceroute \
    tcpdump \
    && rm -rf /var/lib/apt/lists/*

# Install Python and pip
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install penetration testing tools
RUN apt-get update && apt-get install -y \
    nmap \
    nikto \
    dirb \
    sqlmap \
    hydra \
    john \
    wfuzz \
    gobuster \
    whatweb \
    && rm -rf /var/lib/apt/lists/*

# Install Metasploit Framework
RUN apt-get update && apt-get install -y \
    gnupg2 \
    software-properties-common \
    && curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > /tmp/msfinstall \
    && chmod 755 /tmp/msfinstall \
    && /tmp/msfinstall || true \
    && rm -rf /var/lib/apt/lists/*

# Install ttyd (web terminal)
RUN wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 -O /usr/local/bin/ttyd \
    && chmod +x /usr/local/bin/ttyd

# Create helper scripts directory
RUN mkdir -p /opt/pentest

# Create target discovery script
RUN echo '#!/bin/bash\n\
    echo "==========================================="\n\
    echo "  Pentest Lab - Target Discovery"\n\
    echo "==========================================="\n\
    echo ""\n\
    echo "Lab Network: 172.20.0.0/16"\n\
    echo ""\n\
    echo "Known Targets:"\n\
    echo "  1. DVWA (Vulnerable Web App)"\n\
    echo "     IP: 172.20.0.50"\n\
    echo "     URL: http://localhost:8081 (from host)"\n\
    echo "     URL: http://172.20.0.50 (from attacker)"\n\
    echo "     Default Login: admin / password"\n\
    echo ""\n\
    echo "  2. OWASP Juice Shop (Vulnerable E-commerce)"\n\
    echo "     IP: 172.20.0.60"\n\
    echo "     URL: http://localhost:3000 (from host)"\n\
    echo "     URL: http://172.20.0.60:3000 (from attacker)"\n\
    echo ""\n\
    echo "Quick Commands:"\n\
    echo "  - Scan network: nmap -sn 172.20.0.0/16"\n\
    echo "  - Scan DVWA: nmap -sV -p- 172.20.0.50"\n\
    echo "  - Scan Juice: nmap -sV -p- 172.20.0.60"\n\
    echo "  - Web scan DVWA: nikto -h http://172.20.0.50"\n\
    echo "  - Dir enum: dirb http://172.20.0.50"\n\
    echo "==========================================="\n' > /opt/pentest/discover.sh \
    && chmod +x /opt/pentest/discover.sh

# Add helper script to PATH
ENV PATH="/opt/pentest:${PATH}"

# Set working directory
WORKDIR /root

# Create welcome message
RUN echo '#!/bin/bash\n\
    clear\n\
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"\n\
    echo "â•‘                                                           â•‘"\n\
    echo "â•‘        ðŸŽ¯ PENETRATION TESTING LAB - ATTACKER TERMINAL     â•‘"\n\
    echo "â•‘                                                           â•‘"\n\
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"\n\
    echo ""\n\
    echo "Available Tools:"\n\
    echo "  â€¢ nmap      - Network scanner"\n\
    echo "  â€¢ nikto     - Web vulnerability scanner"\n\
    echo "  â€¢ sqlmap    - SQL injection tool"\n\
    echo "  â€¢ dirb      - Directory brute-forcer"\n\
    echo "  â€¢ hydra     - Password cracker"\n\
    echo "  â€¢ metasploit - Exploitation framework"\n\
    echo ""\n\
    echo "Quick Start:"\n\
    echo "  1. Run: discover.sh (to see targets)"\n\
    echo "  2. Scan targets with nmap"\n\
    echo "  3. Attack vulnerabilities!"\n\
    echo ""\n\
    echo "âš ï¸  EDUCATIONAL USE ONLY - Practice ethical hacking!"\n\
    echo ""' > /root/.bashrc

EXPOSE 7681

# Start web terminal
CMD ["ttyd", "-p", "7681", "-W", "bash", "-l"]
