#!/usr/bin/env python3
"""
Vulnerable ICS Service
Intentionally vulnerable service for penetration testing practice
WARNING: For educational use only in isolated environments!
"""

from flask import Flask, request, jsonify, render_template_string
from pymodbus.server.sync import StartTcpServer
from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
import threading
import time
import os

app = Flask(__name__)

# Simulated ICS data
ics_data = {
    'temperature': 25.0,
    'pressure': 100.0,
    'valve_status': 'CLOSED',
    'pump_status': 'OFF',
    'alarm_status': 'NORMAL'
}

# Vulnerable: Hardcoded credentials
USERS = {
    'admin': 'admin123',
    'operator': 'password',
    'engineer': 'engineer',
    'guest': 'guest'
}

# HTML template with XSS vulnerability
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html>
<head>
    <title>ICS Control Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { color: #ffd700; }
        .status-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
        button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #00d4ff; }
        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ ICS Control Panel</h1>
        <p>Vulnerable Target System - For Penetration Testing</p>
        
        <div class="status-card">
            <h2>System Status</h2>
            <p>Temperature: {{ temperature }}Â°C</p>
            <p>Pressure: {{ pressure }} PSI</p>
            <p>Valve: {{ valve_status }}</p>
            <p>Pump: {{ pump_status }}</p>
            <p>Alarm: {{ alarm_status }}</p>
        </div>
        
        <div class="status-card">
            <h2>Control Actions</h2>
            <button onclick="sendCommand('valve', 'open')">Open Valve</button>
            <button onclick="sendCommand('valve', 'close')">Close Valve</button>
            <button onclick="sendCommand('pump', 'on')">Start Pump</button>
            <button onclick="sendCommand('pump', 'off')">Stop Pump</button>
        </div>
        
        <div class="status-card">
            <h2>Search Logs (Vulnerable to XSS)</h2>
            <form action="/search" method="get">
                <input type="text" name="query" placeholder="Search...">
                <button type="submit">Search</button>
            </form>
            {% if search_result %}
            <p>Search result: {{ search_result | safe }}</p>
            {% endif %}
        </div>
    </div>
    
    <script>
        function sendCommand(device, action) {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device: device, action: action})
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
        }
    </script>
</body>
</html>
'''

# Routes

@app.route('/')
def index():
    """Main control panel - vulnerable to various attacks"""
    return render_template_string(HTML_TEMPLATE, **ics_data, search_result=None)

@app.route('/search')
def search():
    """Vulnerable to XSS - doesn't sanitize input"""
    query = request.args.get('query', '')
    # VULNERABILITY: Reflected XSS
    return render_template_string(HTML_TEMPLATE, **ics_data, search_result=query)

@app.route('/api/login', methods=['POST'])
def login():
    """Vulnerable authentication - SQL injection potential"""
    data = request.get_json()
    username = data.get('username', '')
    password = data.get('password', '')
    
    # VULNERABILITY: Hardcoded credentials, no rate limiting
    if username in USERS and USERS[username] == password:
        return jsonify({
            'success': True,
            'message': 'Login successful',
            'token': f'token_{username}_12345'  # Predictable token
        })
    
    return jsonify({'success': False, 'message': 'Invalid credentials'}), 401

@app.route('/api/status', methods=['GET'])
def get_status():
    """Get system status - no authentication required"""
    # VULNERABILITY: Information disclosure
    return jsonify({
        'success': True,
        'data': ics_data,
        'system_info': {
            'version': '1.0.0',
            'os': os.name,
            'python_version': '3.11',
            'debug_mode': True
        }
    })

@app.route('/api/control', methods=['POST'])
def control():
    """Control devices - no authentication or authorization"""
    data = request.get_json()
    device = data.get('device')
    action = data.get('action')
    
    # VULNERABILITY: No authentication, no input validation
    if device == 'valve':
        ics_data['valve_status'] = 'OPEN' if action == 'open' else 'CLOSED'
        return jsonify({'success': True, 'message': f'Valve {action}ed'})
    
    elif device == 'pump':
        ics_data['pump_status'] = 'ON' if action == 'on' else 'OFF'
        return jsonify({'success': True, 'message': f'Pump turned {action}'})
    
    return jsonify({'success': False, 'message': 'Invalid device'}), 400

@app.route('/api/config', methods=['GET', 'POST'])
def config():
    """Configuration endpoint - vulnerable to unauthorized access"""
    if request.method == 'GET':
        # VULNERABILITY: Exposes sensitive configuration
        return jsonify({
            'success': True,
            'config': {
                'modbus_port': 502,
                'admin_password': USERS['admin'],
                'debug_enabled': True,
                'logging_enabled': False,
                'firewall_enabled': False
            }
        })
    
    elif request.method == 'POST':
        # VULNERABILITY: No authentication, allows arbitrary config changes
        data = request.get_json()
        return jsonify({
            'success': True,
            'message': 'Configuration updated',
            'new_config': data
        })

@app.route('/api/execute', methods=['POST'])
def execute():
    """Command execution - CRITICAL VULNERABILITY"""
    data = request.get_json()
    command = data.get('command', '')
    
    # VULNERABILITY: Remote code execution
    # In a real vulnerable system, this would execute commands
    # For safety, we just simulate it
    return jsonify({
        'success': True,
        'message': f'Command simulated: {command}',
        'output': 'This is a simulated vulnerable endpoint. In a real system, this would execute arbitrary commands.'
    })

@app.route('/api/users', methods=['GET'])
def list_users():
    """List all users - information disclosure"""
    # VULNERABILITY: Exposes user list and passwords
    return jsonify({
        'success': True,
        'users': USERS
    })

@app.route('/debug')
def debug():
    """Debug endpoint - should not be exposed in production"""
    # VULNERABILITY: Information disclosure
    return jsonify({
        'environment': dict(os.environ),
        'ics_data': ics_data,
        'users': USERS,
        'request_headers': dict(request.headers)
    })

# Modbus server setup
def start_modbus_server():
    """Start vulnerable Modbus server"""
    print("ğŸ”§ Starting Modbus/TCP server on port 502...")
    
    # Create data blocks
    store = ModbusSlaveContext(
        di=ModbusSequentialDataBlock(0, [0]*100),
        co=ModbusSequentialDataBlock(0, [0]*100),
        hr=ModbusSequentialDataBlock(0, [0]*100),
        ir=ModbusSequentialDataBlock(0, [0]*100)
    )
    
    context = ModbusServerContext(slaves=store, single=True)
    
    # VULNERABILITY: No authentication on Modbus
    try:
        StartTcpServer(context, address=("0.0.0.0", 502))
    except Exception as e:
        print(f"Modbus server error: {e}")

if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘     Vulnerable ICS Service v1.0                â•‘
    â•‘     âš ï¸  FOR EDUCATIONAL USE ONLY âš ï¸             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    Known Vulnerabilities:
    âœ— Hardcoded credentials
    âœ— No authentication on critical endpoints
    âœ— XSS vulnerability in search
    âœ— Information disclosure
    âœ— Predictable tokens
    âœ— No rate limiting
    âœ— Unauthenticated Modbus access
    âœ— Command injection potential
    
    """)
    
    # Start Modbus server in background
    modbus_thread = threading.Thread(target=start_modbus_server, daemon=True)
    modbus_thread.start()
    
    # Start Flask web server
    print("ğŸŒ Starting web interface on port 5000...")
    app.run(host='0.0.0.0', port=5000, debug=True)
